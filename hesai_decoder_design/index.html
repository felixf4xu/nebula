
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Nebula Multi-Sensor Driver Framework">
      
      
      
      
        <link rel="prev" href="../add_sensor/">
      
      
        <link rel="next" href="../nebula_common/links/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.10">
    
    
      
        <title>Hesai Decoder Design - Nebula</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#generic-hesai-decoder" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Nebula" class="md-header__button md-logo" aria-label="Nebula" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nebula
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hesai Decoder Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/tier4/nebula" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../design/" class="md-tabs__link">
        
  
    
  
  Design

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../about/" class="md-tabs__link">
        
  
    
  
  About Nebula

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../add_sensor/" class="md-tabs__link">
        
  
    
  
  Add Your Sensor

      </a>
    </li>
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
    
  
  Hesai Decoder Design

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../nebula_common/links/" class="md-tabs__link">
        
  
    
  
  Nebula Common

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../nebula_decoders/links/" class="md-tabs__link">
        
  
    
  
  Nebula Decoders

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../nebula_hw_interfaces/links/" class="md-tabs__link">
        
  
    
  
  Nebula HW Interfaces

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../nebula_ros/links/" class="md-tabs__link">
        
  
    
  
  Nebula ROS

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Nebula" class="md-nav__button md-logo" aria-label="Nebula" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Nebula
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tier4/nebula" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Nebula
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../add_sensor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Add Your Sensor
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Hesai Decoder Design
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Hesai Decoder Design
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#packet-formats" class="md-nav__link">
    <span class="md-ellipsis">
      Packet formats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoding-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Decoding steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#angle-correction" class="md-nav__link">
    <span class="md-ellipsis">
      Angle correction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Angle correction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#calibration-based" class="md-nav__link">
    <span class="md-ellipsis">
      Calibration based
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correction-based" class="md-nav__link">
    <span class="md-ellipsis">
      Correction based
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timing-correction" class="md-nav__link">
    <span class="md-ellipsis">
      Timing correction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-types" class="md-nav__link">
    <span class="md-ellipsis">
      Return types
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hesaipacket" class="md-nav__link">
    <span class="md-ellipsis">
      HesaiPacket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hesaisensor" class="md-nav__link">
    <span class="md-ellipsis">
      HesaiSensor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anglecorrector" class="md-nav__link">
    <span class="md-ellipsis">
      AngleCorrector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hesaidecodersensort" class="md-nav__link">
    <span class="md-ellipsis">
      HesaiDecoder&lt;SensorT&gt;
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supporting-a-new-sensor" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting a new sensor
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../nebula_common/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nebula Common
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../nebula_decoders/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nebula Decoders
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../nebula_hw_interfaces/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nebula HW Interfaces
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../nebula_ros/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nebula ROS
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#packet-formats" class="md-nav__link">
    <span class="md-ellipsis">
      Packet formats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoding-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Decoding steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#angle-correction" class="md-nav__link">
    <span class="md-ellipsis">
      Angle correction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Angle correction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#calibration-based" class="md-nav__link">
    <span class="md-ellipsis">
      Calibration based
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correction-based" class="md-nav__link">
    <span class="md-ellipsis">
      Correction based
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timing-correction" class="md-nav__link">
    <span class="md-ellipsis">
      Timing correction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-types" class="md-nav__link">
    <span class="md-ellipsis">
      Return types
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hesaipacket" class="md-nav__link">
    <span class="md-ellipsis">
      HesaiPacket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hesaisensor" class="md-nav__link">
    <span class="md-ellipsis">
      HesaiSensor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anglecorrector" class="md-nav__link">
    <span class="md-ellipsis">
      AngleCorrector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hesaidecodersensort" class="md-nav__link">
    <span class="md-ellipsis">
      HesaiDecoder&lt;SensorT&gt;
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supporting-a-new-sensor" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting a new sensor
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="generic-hesai-decoder">Generic Hesai Decoder</h1>
<p>Since sensors from the same vendor often follow similar conventions when it comes to packet structure and data processing steps, a generic decoder can be used for most of the decoding work.
This document outlines the requirements and design of the generic Hesai decoder.</p>
<h2 id="requirements">Requirements</h2>
<p>There shall only be one decoder class which makes use of static (template) polymorphism to handle different sensor types.
This way, runtime overhead for this generalization is <code>0</code>.</p>
<h3 id="packet-formats">Packet formats</h3>
<p>For all handled Hesai sensors, the packet structure follows this rough format:
1. (optional) header: static sensor info and feature flags
2. body: point data
3. tail and other appendices: timestamp, operation mode info</p>
<h3 id="decoding-steps">Decoding steps</h3>
<p>For all handled Hesai sensors, decoding a packet follows these steps:
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="n">parse_and_validate</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="c1"># return group: one (single-return) or more (multi-return) </span>
    <span class="c1"># blocks that belong to the same azimuth</span>
    <span class="k">for</span> <span class="n">return_group</span> <span class="ow">in</span> <span class="n">packet</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_start_of_new_scan</span><span class="p">(</span><span class="n">return_group</span><span class="p">):</span>
            <span class="c1"># swap output buffers etc.</span>
        <span class="n">decode</span><span class="p">(</span><span class="n">return_group</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">return_group</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">return_group</span><span class="p">:</span>
        <span class="nb">filter</span> <span class="n">by</span><span class="p">:</span>
          <span class="n">distance</span> <span class="n">thresholds</span>
          <span class="n">distance</span> <span class="n">to</span> <span class="n">other</span> <span class="n">returns</span>
        <span class="n">correct</span> <span class="n">azimuth</span><span class="o">/</span><span class="n">elevation</span> <span class="o">*</span>
        <span class="n">compute</span> <span class="n">x</span><span class="o">/</span><span class="n">y</span><span class="o">/</span><span class="n">z</span> <span class="n">using</span> <span class="n">sin</span><span class="o">/</span><span class="n">cos</span> <span class="n">lookup</span> <span class="n">tables</span> <span class="o">*</span>
        <span class="n">compute</span> <span class="n">time_offset</span> <span class="n">to</span> <span class="n">scan</span> <span class="o">*</span>
        <span class="n">determine</span> <span class="n">return_type</span> <span class="o">*</span>
        <span class="n">append</span> <span class="n">to</span> <span class="n">pointcloud</span>
</code></pre></div></p>
<p>The steps marked with <strong>*</strong> are model-specific:</p>
<ul>
<li>angle correction</li>
<li>timing correction</li>
<li>return type assignment</li>
</ul>
<h3 id="angle-correction">Angle correction</h3>
<p>There are two approaches between all the supported sensors:
* Calibration file based
* Correction file based (currently only used by AT128)</p>
<p>For both approaches, sin/cos lookup tables can be computed.
However, the resolution and calculation of these tables is different.</p>
<h4 id="calibration-based">Calibration based</h4>
<p>For each laser channel, a fixed elevation angle and azimuth angle offset are defined in the calibration file.
Thus, sin/cos for elevation are only a function of the laser channel (not dependent on azimuth) while those for azimuth are a function of azimuth AND elevation.</p>
<p>Lookup tables for elevation can thus be sized with <code>n_channels</code>, yielding a maximum size of 
<code>128 * sizeof(float) = 512B</code> each.</p>
<p>For azimuth, the size is <code>n_channels * n_azimuths = n_channels * 360 * azimuth_resolution &lt;= 128 * 36000</code>.
This yields a table size of <code>128 * 36000 * sizeof(float) ≈ 18.4MB</code>.</p>
<h4 id="correction-based">Correction based</h4>
<p>While azimuth and elevation correction also have a per-channel component, an additional component depending on azimuth AND channel is present.
The angular resolution of AT128 is <code>1 / (100 * 256) deg</code> and the per-channel correction as well as the additional component are defined as integers with the same or <code>1 / 100 deg</code> resolution respectively.
This means that a lookup table of length <code>360 * 100 * 256</code> will contain sin/cos for all corrected values, since the resolution of corrections is smaller/equal to the base angular resolution.</p>
<p>The lookup tables (of which there only need to be two: sin, cos; both usable for azimuth/elevation) each have a size of <code>360 * 100 * 256 * sizeof(float) ≈ 36.9MB</code>.</p>
<h3 id="timing-correction">Timing correction</h3>
<p>Each sensor features an absolute timestamp per packet and formulae to compute the relative time between a unit or block and the packet.</p>
<p>The desired output features a start timestamp per scan, and a relative timestamp to the scan for each point.</p>
<p>Thus, the scan timestamp must be computed as the timestamp of the earliest point in the scan, and all packet-relative point times need to be converted to scan-relative ones.
The earliest point in a scan is guaranteed to be in the first return group (≈ first 1-3 blocks) of the scan.
Note that a scan can start mid-packet, if the scan phase does not align with packet bounds.</p>
<p>The block offset follows a formula linear in the block index for all sensor models which additionally depends on the number of returns of the currently active <code>return_mode</code>. The parametrization is different for each sensor.</p>
<p>The channel offset is given as a formula, table or set of tables for all sensors. A few sensors' formula is influenced by factors such as high resolution mode (128E3X, 128E4X), alternate firing sequences (QT128) and near/farfield firing (128E3X).</p>
<h3 id="return-types">Return types</h3>
<p>While there is a wide range of different supported return modes (e.g. single (first), single (strongest), dual (first, last), etc.) their handling is largely the same.
Differences only arise in multi-return (dual or triple) in the output order of the returns, and in the handling of some returns being duplicates (e.g. in dual(first, strongest), the first return coincides with the strongest one).</p>
<p>Here is an exhaustive list of differences:
* For Dual (First, Last) <code>0x3B</code>, 128E3X, 128E4X and XT32 reverse the output order (Last, First)
* For Dual (Last, Strongest) <code>0x39</code>, all sensors except XT32M place the second strongest return in the even block if last == strongest
* For Dual (First, Strongest) <code>0x3c</code>, the same as for <code>0x39</code> holds.</p>
<p>For all other return modes, duplicate points are output if the two returns coincide.</p>
<h2 id="implementation">Implementation</h2>
<h3 id="hesaipacket"><code>HesaiPacket</code></h3>
<p>Packets are defined as <strong>packed</strong> structs to enable parsing via <code>memcpy</code>.
The sensor-specific layout for sensor XYZ is defined in <code>PacketXYZ</code> and usually employs an own <code>TailXYZ</code> struct.
The header formats are largely shared between sensors.
The packet body (i.e. point data) is mainly parameterized by bytes per point, points per block, and blocks per body. Thus, parameterized templated structs are used. A few skews such as fine azimuth blocks and blocks with a start-of-block (SOB) header exist and are implemented as their own structs.</p>
<p><img alt="HesaiPacket diagram" src="../GenericHesaiDecoder-Packet%20Formats.png" /></p>
<h3 id="hesaisensor"><code>HesaiSensor</code></h3>
<p>Each sensor model has its own class <code>PandarXYZ : HesaiSensor&lt;...&gt;</code> that defines packet type and timing, and return mode handling logic. Angle correction is the same for 90% of sensors and thus outsourced into <code>AngleCorrector</code> and subclasses. These are template arguments for <code>HesaiSensor</code>.
Return mode handling has a default implementation that is supplemented by additional logic only in 3 sensors.</p>
<h3 id="anglecorrector"><code>AngleCorrector</code></h3>
<p>The angle corrector has three main tasks:
* compute corrected azimuth/elevation for given azimuth and channel
* implement <code>hasScanCompleted()</code> logic that decides where one scan ends and the next starts
* compute and provide lookup tables for sin/cos/etc.</p>
<p>The two angle correction types are calibration-based and correction-based. In both approaches, a file from the sensor is used to extract the angle correction for each azimuth/channel.
For all approaches, cos/sin lookup tables in the appropriate size are generated (see requirements section above).</p>
<h3 id="hesaidecodersensort"><code>HesaiDecoder&lt;SensorT&gt;</code></h3>
<p>The decoder is in charge of the control flow and shared decoding steps of all sensors.
It is a template class taking a sensor type <code>SensorT</code> from which packet type, angle correction etc. are deducted at compile time.
Thus, this unified decoder is an almost zero-cost abstraction.</p>
<p>Its tasks are:
* parsing an incoming packet
* managing decode/output point buffers
* converting all points in the packet using the sensor-specific functions of <code>SensorT</code> where necessary</p>
<p><code>HesaiDecoder&lt;SensorT&gt;</code> is a subclass of the existing <code>HesaiScanDecoder</code> to allow all template instantiations to be assigned to variables of the supertype.</p>
<h2 id="supporting-a-new-sensor">Supporting a new sensor</h2>
<p>To support a new sensor model, first familiarize with the already implemented decoders.
Then, consult the new sensor's datasheet and identify the following parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Chapter</th>
<th>Possible values</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Header format</td>
<td>3.1</td>
<td><code>Header12B</code>, <code>Header8B</code>, ...</td>
<td><code>Header12B</code> is the standard and comprises the UDP pre-header and header (6+6B) mentioned in the data sheets</td>
</tr>
<tr>
<td>Blocks per packet</td>
<td>3.1</td>
<td><code>2</code>, <code>6</code>, <code>10</code>, ...</td>
<td></td>
</tr>
<tr>
<td>Number of channels</td>
<td>3.1</td>
<td><code>32</code>, <code>40</code>, <code>64</code>, ...</td>
<td></td>
</tr>
<tr>
<td>Unit format</td>
<td>3.1</td>
<td><code>Unit3B</code>, <code>Unit4B</code>, ...</td>
<td></td>
</tr>
<tr>
<td>Angle correction</td>
<td>App. 3</td>
<td><code>CALIBRATION</code>, <code>CORRECTION</code>, ...</td>
<td>The datasheet usually specifies whether a calibration/correction file is used</td>
</tr>
<tr>
<td>Timing correction</td>
<td>App. 2</td>
<td></td>
<td>There is usually a block and channel component. These come in the form of formulas/lookup tables. For most sensors, these depend on return mode and for some, features like high resolution mode, alternate firing etc. might change the timing</td>
</tr>
<tr>
<td>Return type handling</td>
<td>3.1</td>
<td></td>
<td>Return modes are handled identically for most sensors but some re-order the returns or replace returns if there are duplicates</td>
</tr>
<tr>
<td>Bytes per second</td>
<td>1.4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Lowest supported frequency</td>
<td>1.4</td>
<td><code>5 Hz</code>, <code>10 Hz</code>, ...</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Chapter</th>
<th>Full title</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.4</td>
<td>Introduction &gt; Specifications</td>
</tr>
<tr>
<td>3.1</td>
<td>Data Structure &gt; Point Cloud Data Packet</td>
</tr>
<tr>
<td>App. 2</td>
<td>Absolute Time of Point Cloud Data</td>
</tr>
<tr>
<td>App. 3</td>
<td>Angle Correction</td>
</tr>
</tbody>
</table>
<p>With this information, create a <code>PacketMySensor</code> struct and <code>SensorMySensor</code> class.
Reuse already-defined structs as much as possible (c.f. <code>Packet128E3X</code> and <code>Packet128E4X</code>).</p>
<p>Implement timing correction in <code>SensorMySensor</code> and define the class constants <code>float MIN_RANGE</code>,
<code>float MAX_RANGE</code> and <code>size_t MAX_SCAN_BUFFER_POINTS</code>.
The former two are used for filtering out too-close and too-far away points while the latter is used to
allocate pointcloud buffers. 
Set <code>MAX_SCAN_BUFFER_POINTS = bytes_per_second / lowest_supported_frequency</code> from the parameters found above.</p>
<p>If there are any non-standard features your sensor has, implement them as generically as possible to allow for future sensors to re-use your code.</p>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 TIER IV, Inc.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c14ae12.min.js"></script>
      
    
  </body>
</html>